# PostgreSQL Database Schema for 10xWorkoutManager

## 1. List of tables with their columns, data types, and constraints

### `public.muscle_groups`
Stores the predefined categories for exercises (e.g., Chest, Back, Legs).

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the muscle group. |
| `name` | `TEXT` | `NOT NULL`, `UNIQUE` | The name of the muscle group. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |

---

### `public.exercises`
Stores both predefined (global) and user-created exercises.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the exercise. |
| `user_id` | `UUID` | `FOREIGN KEY` references `auth.users(id)` `ON DELETE CASCADE` | The user who created the exercise. `NULL` for predefined exercises. |
| `muscle_group_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.muscle_groups(id)` `ON DELETE RESTRICT` | The muscle group this exercise belongs to. |
| `name` | `TEXT` | `NOT NULL` | The name of the exercise. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |
| **Composite Constraints** | | | `UNIQUE(user_id, name)` and `UNIQUE(name) WHERE (user_id IS NULL)` |

---

### `public.workout_plans`
Stores the workout plans created by users.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the workout plan. |
| `user_id` | `UUID` | `NOT NULL`, `FOREIGN KEY` references `auth.users(id)` `ON DELETE CASCADE` | The user who owns this plan. |
| `name` | `TEXT` | `NOT NULL` | The name of the workout plan. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |

---

### `public.training_days`
Stores the individual training days within a workout plan (e.g., Day A, Day B).

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the training day. |
| `plan_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.workout_plans(id)` `ON DELETE CASCADE` | The plan this day belongs to. |
| `name` | `TEXT` | `NOT NULL` | The name of the training day. |
| `order` | `SMALLINT` | `NOT NULL`, `CHECK ("order" >= 0)` | The sequence of this day within the plan. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |

---

### `public.plan_day_exercises`
A junction table linking exercises to specific training days, defining the structure of a workout.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the entry. |
| `training_day_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.training_days(id)` `ON DELETE CASCADE` | The training day. |
| `exercise_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.exercises(id)` `ON DELETE CASCADE` | The exercise. |
| `order` | `SMALLINT` | `NOT NULL`, `CHECK ("order" >= 0)` | The sequence of this exercise within the day. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |

---

### `public.sessions`
Stores a record of each training session a user performs.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the session. |
| `user_id` | `UUID` | `NOT NULL`, `FOREIGN KEY` references `auth.users(id)` `ON DELETE CASCADE` | The user who performed the session. |
| `plan_id` | `BIGINT` | `FOREIGN KEY` references `public.workout_plans(id)` `ON DELETE SET NULL` | The plan used for the session (optional). |
| `notes` | `TEXT` | | Optional notes for the entire session. |
| `start_time` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | The start time of the session. |
| `end_time` | `TIMESTAMPTZ` | | The end time of the session. |

---

### `public.session_exercises`
Stores details of each exercise performed within a session.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the entry. |
| `session_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.sessions(id)` `ON DELETE CASCADE` | The session this exercise belongs to. |
| `exercise_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.exercises(id)` `ON DELETE RESTRICT` | The exercise that was performed. |
| `notes` | `TEXT` | | Optional notes for this specific exercise. |
| `skipped` | `BOOLEAN` | `NOT NULL`, `DEFAULT FALSE` | `TRUE` if the exercise was skipped. |
| `order` | `SMALLINT` | `NOT NULL`, `CHECK ("order" >= 0)` | The sequence of the exercise within the session. |

---

### `public.exercise_sets`
Stores the results of each individual set performed for an exercise in a session.

| Column Name | Data Type | Constraints | Description |
|---|---|---|---|
| `id` | `BIGINT` | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unique identifier for the set. |
| `session_exercise_id` | `BIGINT` | `NOT NULL`, `FOREIGN KEY` references `public.session_exercises(id)` `ON DELETE CASCADE` | The session exercise this set belongs to. |
| `weight` | `DECIMAL(10, 2)` | `NOT NULL`, `CHECK (weight >= 0)` | The weight used (in kg). |
| `reps` | `SMALLINT` | `NOT NULL`, `CHECK (reps >= 0)` | The number of repetitions performed. |
| `is_failure` | `BOOLEAN` | `NOT NULL`, `DEFAULT FALSE` | `TRUE` if the set was performed to muscle failure. |
| `order` | `SMALLINT` | `NOT NULL`, `CHECK ("order" >= 0)` | The sequence of this set for the exercise. |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT NOW()` | Timestamp of creation. |

## 2. Relationships between tables

- **`auth.users` <-> `workout_plans`**: One-to-Many. A user can have many workout plans.
- **`auth.users` <-> `exercises`**: One-to-Many. A user can create many custom exercises.
- **`auth.users` <-> `sessions`**: One-to-Many. A user can have many training sessions.
- **`muscle_groups` <-> `exercises`**: One-to-Many. A muscle group can be associated with many exercises.
- **`workout_plans` <-> `training_days`**: One-to-Many. A plan can have many training days.
- **`workout_plans` <-> `sessions`**: One-to-Many. A workout plan can be associated with many sessions (optional link via `plan_id`). Used in SessionRepository with Supabase nested projection: `Select("*, workout_plans(*)")`.
- **`training_days` <-> `exercises`**: Many-to-Many, via the `plan_day_exercises` junction table. A training day can have many exercises, and an exercise can be in many training days.
- **`sessions` <-> `session_exercises`**: One-to-Many. A session consists of many performed exercises.
- **`session_exercises` <-> `exercise_sets`**: One-to-Many. A performed exercise consists of many sets.
- **`exercises` <-> `session_exercises`**: One-to-Many. An exercise can be performed in many sessions.

## 3. Indexes

- **Primary Keys**: PostgreSQL automatically creates a B-tree index on the primary key for each table.
- **Foreign Keys**: PostgreSQL automatically creates indexes on foreign key columns.
- **Custom Indexes**: An index on `exercises(name)` will be beneficial for search performance.

## 4. PostgreSQL policies (Row-Level Security)

RLS will be enabled on all tables containing user-specific data to ensure users can only access their own information.

- **`muscle_groups`**:
  - `SELECT`: Allowed for any authenticated user.
- **`exercises`**:
  - `SELECT`: Allowed if the exercise is predefined (`user_id` is `NULL`) OR the user is the owner (`user_id = auth.uid()`).
  - `INSERT`, `UPDATE`, `DELETE`: Allowed only if the user is the owner.
- **`workout_plans`**:
  - `ALL`: Allowed only if the user is the owner.
- **`training_days`**:
  - `ALL`: Allowed only if the user is the owner of the parent `workout_plan`.
- **`plan_day_exercises`**:
  - `ALL`: Allowed only if the user is the owner of the parent `workout_plan`.
- **`sessions`**:
  - `ALL`: Allowed only if the user is the owner.
- **`session_exercises`**:
  - `ALL`: Allowed only if the user is the owner of the parent `session`.
- **`exercise_sets`**:
  - `ALL`: Allowed only if the user is the owner of the parent `session`.

## 5. Any additional notes or explanations about design decisions

- **User Data Deletion**: The `ON DELETE CASCADE` option is used on foreign keys referencing `auth.users(id)`. This ensures that when a user deletes their account, all their associated data (plans, sessions, custom exercises) is automatically and permanently removed from the database, fulfilling a key product requirement.
- **Exercise Management**: A single `exercises` table with a nullable `user_id` is used to efficiently manage both a global, predefined list of exercises and user-created custom exercises without data duplication.
- **Category Flexibility**: A dedicated `muscle_groups` table is used instead of a PostgreSQL `ENUM` type to allow for future additions or modifications to exercise categories without requiring a schema migration.
- **Data Integrity**: `CHECK` constraints are applied to columns like `weight`, `reps`, and `order` to enforce business rules (e.g., values cannot be negative) at the database level.
- **Ordering**: An `order` column is included in relevant tables (`training_days`, `plan_day_exercises`, `session_exercises`, `exercise_sets`) to preserve the user-defined sequence of items, which is critical for the application's logic.
